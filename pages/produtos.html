<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Produtos | H&I</title>
    <link rel="stylesheet" href="../assets/css/styles.css">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap">
</head>

<body>
    <!---------- Header ----------------->
    <div class="navbar">
        <div class="logo">
            <a href="../index.html" aria-label="Logo"><img src="../assets/images/logo.png" width="125px"
                    alt="logo"></a>
        </div>
        <nav>
            <ul id="MenuItems">
                <li><a href="../index.html">Início</a></li>
                <li><a href="produtos.html">Produtos</a></li>
                <!-- <li><a href="sobre.html">Sobre</a></li>
                    <li><a href="contato.html">Contato</a></li> -->
                <li><a href="conta.html">Conta</a></li>
                <!--<li>
                        <a href="pages/carrinho.html"><img src="assets/images/carrinho.png" width="30px" height="30px"
                                                           alt="carrinho"></a>
                        <img src="assets/images/menu.png" class="menu-icon" onclick="menutoggle()" alt="menu">
                    </li>-->
            </ul>
        </nav>
    </div>
    <!-------- Todos Produtos -------->
    <div class="small-grupo linha">
        <div class="coluna-1">
            <h2>Todos Produtos</h2>
            <select aria-label="label para select" id="categoria">

            </select>
        </div>
        <div class="coluna-2">
            <input type="text" id="inputNomeAnuncio" placeholder="Digite o nome do anúncio">
            <button id="btnBuscarAnuncio">Buscar</button>
        </div>
    </div>

    <section id="products" class="small-grupo">
        <template id="template">
            <div class="item">
                <img class="item-image" src="../assets/images/{{prod-image}}"></img>
                <span class="item-name">{{prod-name}}</span>
                <span class="item-price">{{prod-price}}</span>
            </div>
        </template>
    </section>


    <!---- Rodapé ------>
    <div class="rodape">
        <div class="grupo">
            <div class="linha">
                <div class="rodape-coluna-1">
                    <h3>Baixe nosso App</h3>
                    <p>Disponível tanto para Android quanto para iOS</p>
                    <div class="app-logo">
                        <img src="../assets/images/play-store.png" alt="play-store">
                        <img src="../assets/images/app-store.png" alt="app-store">
                    </div>
                </div>
                <div class="rodape-coluna-2">
                    <img src="../assets/images/logo-white.png" alt="logo-white">
                    <p>Nosso propósito é oferecer a melhor experência possível a um preço justo para nossos fiés
                        clientes </p>
                </div>
                <div class="rodape-coluna-3">
                    <h3>Links úteis</h3>
                    <ul>
                        <li>Cupons</li>
                        <li>Nosso blog</li>
                        <li>Política de devolução</li>
                        <li>Seja um afiliado</li>
                    </ul>
                </div>
            </div>
            <hr>
            <p class="copyright">&copy; Copyright 2023 - H&I Inc.</p>
        </div>
    </div>
    <!----------- script para ativar menu em mobile (em formato burguer) ------->
    <script>
        var MenuItems = document.getElementById("MenuItems")
        MenuItems.style.maxHeight = "0px";
        function menutoggle() {
            if (MenuItems.style.maxHeight == "0px") {
                MenuItems.style.maxHeight = "200px";
            }
            else {
                MenuItems.style.maxHeight = "0px";
            }
        }

        // funcao para buscar todas as categorias no banco de dados e colocar no label para select usando fetch

        function buscarCategorias() {
            fetch('../php/categorias.php')
                .then(response => response.json())
                .then(data => {
                    let html = '<option value="">Selecione uma categoria</option>';
                    data.forEach(categoria => {
                        html += `<option value="${categoria.code}">${categoria.name}</option>`;
                    });
                    document.getElementById('categoria').innerHTML = html;
                });
        }

        // funcao para buscar todos os produtos de acordo com a categoria selecionada

        function renderProducts(newProducts) {
            const prodsSection = document.getElementById("products");
            const template = document.getElementById("template");

            // Remove os produtos antigos
            while (prodsSection.children.length > 1) {
                prodsSection.removeChild(prodsSection.lastChild);
            }

            // Adiciona os novos produtos
            for (let product of newProducts) {
                let productElement = template.content.cloneNode(true);
                productElement.querySelector(".item-image").src = "../assets/images/" + product.imagePath;
                productElement.querySelector(".item-name").textContent = product.name;
                productElement.querySelector(".item-price").textContent = product.price;

                productElement.querySelector(".item").addEventListener("click", function () {
                    redirectToProductPage(product.code); // Redirecionar para a página do produto com o ID do produto
                });

                prodsSection.appendChild(productElement);
            }
        }

        async function loadProducts() {

            try {

                var selectCategoria = document.getElementById('categoria');
                // Obtém o valor selecionado do select da categoria
                var codCategoria = selectCategoria.value;
                // Verifica se um valor de categoria foi selecionado

                let response = await fetch('../php/produtos.php?codCategoria=' + codCategoria);
                if (!response.ok) throw new Error(response.statusText);
                var products = await response.json();
            }
            catch (e) {
                console.error(e);
                return;
            }

            renderProducts(products);
        }

        // funcao para buscar o produto pelo nome
        async function buscarAnuncioPorNome() {
            try {
                var selecNomeProd = document.getElementById('inputNomeAnuncio');
                // Obtém o valor selecionado do select da categoria
                var nomeProd = selecNomeProd.value;
                // Verifica se um valor de categoria foi selecionado

                let response = await fetch('../php/produtos.php?nome=' + nomeProd);
                if (!response.ok) throw new Error(response.statusText);
                var products = await response.json();
            }
            catch (e) {
                console.error(e);
                return;
            }

            renderProducts(products);
        }

        // Adicione um evento de clique ao botão de busca
        const btnBuscarAnuncio = document.getElementById("btnBuscarAnuncio");
        btnBuscarAnuncio.addEventListener("click", buscarAnuncioPorNome);


        // funcao para que a cada vez que mudar a categoria selecionada, os produtos atuais sejam exluídos e os novos sejam carregados

        var selectCategoria = document.getElementById('categoria');
        selectCategoria.addEventListener('change', loadProducts);


        window.onload = function () {
            buscarCategorias();
            loadProducts();
        };

        window.onscroll = function () {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight) {
                loadProductsInfinity();
            }
        };

        let offset = 0; // Variável para controlar a quantidade de anúncios já carregados

        async function loadProductsInfinity() {
            try {
                var selectCategoria = document.getElementById('categoria');
                var codCategoria = selectCategoria.value;

                // Adicione a variável "page" para indicar a página atual
                var page = Math.ceil((document.getElementById("products").children.length - 1) / 6) + 1;

                let response = await fetch(`../php/produtos.php?codCategoria=${codCategoria}&page=${page}`);
                if (!response.ok) throw new Error(response.statusText);
                var products = await response.json();

                renderProductsInfinity(products);
            } catch (e) {
                console.error(e);
                return;
            }
        }

        function renderProductsInfinity(newProducts) {
            const prodsSection = document.getElementById("products");
            const template = document.getElementById("template");

            // Adiciona os novos produtos
            for (let product of newProducts) {
                let productElement = template.content.cloneNode(true);
                productElement.querySelector(".item-image").src = "../assets/images/" + product.imagePath;
                productElement.querySelector(".item-name").textContent = product.name;
                productElement.querySelector(".item-price").textContent = product.price;

                productElement.querySelector(".item").addEventListener("click", function () {
                    redirectToProductPage(product.code); // Redirecionar para a página do produto com o ID do produto
                });

                prodsSection.appendChild(productElement);
            }
        }

        function redirectToProductPage(productId) {
            // Redirecionar para a página produto.php com o ID do produto
            window.location.href = `../php/produto.php?id=${productId}`;
        }

    </script>
</body>

</html>